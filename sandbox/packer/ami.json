{
  "variables": {
    "aws_access_key": "",
    "aws_secret_key": "",
    "source_ami": "",
    "region": "",
    "version": "",
    "environment": "",
    "userHome": "",
    "efs_id": "",
    "av_zone": ""
  },
  "builders": [{
    "type": "amazon-ebs",
    "access_key": "{{user `aws_access_key`}}",
    "secret_key": "{{user `aws_secret_key`}}",
    "region": "{{user `region`}}",
    "source_ami": "{{user `source_ami`}}",
    "instance_type": "t2.micro",
    "ssh_username": "ubuntu",
    "ami_name": "Sandbox({{user  `av_zone`}}) - {{user `version`}}",
    "tags": {
      "Build_Number": "{{user `version`}}",
      "Environment": "{{user  `environment`}}",
      "AvailabilityZone": "{{user  `av_zone`}}"
    }
  }],
  "provisioners": [
    {
      "type": "shell",
      "inline": ["sudo add-apt-repository ppa:ansible/ansible && sudo apt-get update && sudo apt-get install -y ansible"]
    },
    {
      "type": "file",
      "source": "{{user `userHome`}}/.sepal/certificates/docker-registry.crt",
      "destination": "/tmp/docker-registry.crt"
    },
    {
      "type": "file",
      "source": "/opt/sepal/sandbox/ansible/pull-sandbox/templates/login_to_repo",
      "destination": "/tmp/login_to_repo"
    },
    {
      "type": "file",
      "source": "/opt/sepal/sandbox/ansible/pull-sandbox/templates/pull_sandbox.sh",
      "destination": "/tmp/pull_sandbox.sh"
    },
    {
      "type": "file",
      "source": "{{user `userHome`}}/.sepal/secret.yml",
      "destination": "/tmp/secret.yml"
    },


    {
    "type": "ansible-local",
    "playbook_file": "/opt/sepal/sandbox/ansible/provision-sandbox/provision.yml",
    "extra_arguments": [ "--extra-vars \"efs_id={{user `efs_id`}} region={{user `region`}} availability_zone={{user `av_zone`}}\""  ],
    "role_paths": [
      "/opt/sepal/sandbox/ansible/pull-sandbox",
      "/opt/sepal/ansible/roles/docker.ubuntu",
      "/opt/sepal/ansible/roles/unattended-upgrades"
    ]
  }]
}