{% extends "layout.html" %}

{% block body %}

<div id="maps">
    <div class="map-control map-control-left">
        <select class="selector-control" id="base-selector">
            <option value="">SEPAL</option>
            <option value="satellite">SATELLITE</option>
        </select>
    </div>
    <div id="gmap"></div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" id="chart-modal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div id="chart" style="width:100%; height:400px;"></div>
            </div>
        </div>
    </div>
</div>

<script>

    $(document).ready(function() {

        var peatlandsApiUrl = '{{config.PEATLANDS_API_URL}}';

        var gmap;

        var mapStyle = [
            {
                "stylers": [ { "visibility": "simplified" } ]
            }, {
                "stylers": [ { "color": "#131314" } ]
            }, {
                "featureType": "water",
                "stylers"    : [ { "color": "#131313" }, { "lightness": 4 }
                ]
            }, {
                "elementType": "labels.text.fill"
                , "stylers"  : [ { "visibility": "off" }, { "lightness": 25 } ]
            }
        ];

        var gOptions = {
            zoom             : 3,
            center           : new google.maps.LatLng(0, 0),
            mapTypeId        : google.maps.MapTypeId.ROADMAP,
            zoomControl      : false,
            mapTypeControl   : false,
            scaleControl     : false,
            streetViewControl: false,
            rotateControl    : false,
            fullscreenControl: false,
            animatedZoom     : false,
            tilt: 0,
            backgroundColor  : '#131314',
            draggableCursor  : 'crosshair'
        };

        // google maps init
        gmap = new google.maps.Map(window.document.getElementById('gmap'), gOptions);

        gmap.setOptions( { styles: mapStyle } );
        var gBounds = new google.maps.LatLngBounds();

        $('#base-selector').change(function(e) {
            var selectedBase = $(this).val();
            if (selectedBase == '') {
                gmap.setMapTypeId(google.maps.MapTypeId.ROADMAP);
            } else if (selectedBase == 'satellite') {
                gmap.setMapTypeId(google.maps.MapTypeId.SATELLITE);
            }
        });

        let ftLayer = new google.maps.FusionTablesLayer({
            suppressInfoWindows: true,
            query: {
                from: '1-kv2WWZfEjOuvUhuB3YJj3zIIxn0tzZR6Hg0bUrr',
                select: 'geometry',
                //where: `'${keyColumn}' = '${key}'`
            },
            //styles: [{polygonOptions: {...polygonOptions(fill)}}]
        })
        ftLayer.setMap(gmap);

        const clickEvent = (e) =>  {
            let latLng = e.latLng;
            $.ajax({
                url: peatlandsApiUrl + '/get-timeseries',
                method: 'post',
                data: JSON.stringify({
                    'lat': latLng.lat(),
                    'lng': latLng.lng()
                }),
                contentType: 'application/json;charset=UTF-8'
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error(jqXHR, textStatus, errorThrown);
            }).done(function(data, textStatus, jqXHR) {
                    let indexName = 'SMAP';
                    $('#chart-modal').modal('show');
                    var text = indexName;
                    Highcharts.chart('chart', {
                        chart: {
                            zoomType: 'x'
                        },
                        title: {
                            text: text
                        },
                        subtitle: {
                            text: document.ontouchstart === undefined ? 'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
                        },
                        xAxis: {
                            type: 'datetime'
                        },
                        yAxis: {
                            title: {
                                text: indexName
                            }
                        },
                        legend: {
                            enabled: false
                        },
                        plotOptions: {
                            area: {
                                fillColor: {
                                    linearGradient: {
                                        x1: 0,
                                        y1: 0,
                                        x2: 0,
                                        y2: 1
                                    },
                                    stops: [
                                        [0, Highcharts.getOptions().colors[0]],
                                        [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                                    ]
                                },
                                marker: {
                                    radius: 2
                                },
                                lineWidth: 1,
                                states: {
                                    hover: {
                                        lineWidth: 1
                                    }
                                },
                                threshold: null
                            }
                        },
                        series: [{
                            name: indexName,
                            data: data,
                            lineWidth: 0,
                            marker: {
                                enabled: true,
                                radius: 2
                            },
                            tooltip: {
                                valueDecimals: 2
                            },
                            states: {
                                hover: {
                                    lineWidthPlus: 0
                                }
                            }
                        }],
                        credits: {
                            enabled: false
                        }
                    });
            });

        }

        //gmap.addListener('click', clickEvent);
        google.maps.event.addListener(ftLayer, 'click', clickEvent);

    });

</script>

{% endblock %}
